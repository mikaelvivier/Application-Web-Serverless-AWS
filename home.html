<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Twitwi - Messages</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link 
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" 
    rel="stylesheet"
  >
  <style>
    :root {
      --bg-color: #f8f9fa;
      --text-color: #212529;
      --card-bg: #fff;
      --border-color: #dee2e6;
    }

    @media (prefers-color-scheme: dark) {
      :root {
        --bg-color: #121212;
        --text-color: #e9ecef;
        --card-bg: #1e1e1e;
        --border-color: #2b2b2b;
      }
    }

    body {
      background-color: var(--bg-color);
      color: var(--text-color);
    }

    .card {
      background-color: var(--card-bg);
      border: 1px solid var(--border-color);
      border-radius: 1rem;
      box-shadow: 0 4px 10px rgba(0,0,0,0.05);
    }

    .message {
      background-color: var(--card-bg);
      border: 1px solid var(--border-color);
      border-radius: .5rem;
      padding: .75rem 1rem;
      margin-bottom: .5rem;
    }

    .message strong {
      color: #0d6efd;
    }

    .form-control, .btn {
      border-radius: .5rem;
    }

    .btn-primary, .btn-success {
      color: white !important;
    }
  </style>
</head>
<body>
  <div class="container py-4">
    <div class="text-center mb-4">
      <h1 class="fw-bold text-primary">Twitwi</h1>
      <p class="text-secondary"> Channel <span id="current_channel">?</span></p>
    </div>

    <div class="card p-4 mb-4">
      <h5 class="mb-3">üîé Charger les messages d‚Äôun channel</h5>
      <form id="loadForm" class="row g-2">
        <div class="col-md-8">
          <input type="text" id="load_channel_id" class="form-control" placeholder="Nom du channel" value="astra" required>
        </div>
        <div class="col-md-4 d-grid">
          <button type="submit" class="btn btn-primary">Charger</button>
        </div>
      </form>
    </div>

    <div class="card p-4 mb-4">
      <h5 class="mb-3">üí¨ Messages</h5>
      <div id="messages" class="border rounded p-3 bg-light text-secondary">
        Aucun channel s√©lectionn√©.
      </div>
      <div id="pagination" class="d-flex justify-content-between mt-3" style="display:none;">
        <button id="prevBtn" class="btn btn-outline-secondary btn-sm" disabled>‚¨ÖÔ∏è Pr√©c√©dent</button>
        <button id="nextBtn" class="btn btn-outline-secondary btn-sm" disabled>Suivant ‚û°Ô∏è</button>
      </div>
    </div>

    <div class="card p-4">
      <h5 class="mb-3">‚úâÔ∏è Envoyer un message</h5>
      <form id="messageForm">
        <div class="mb-2">
          <input type="text" id="author" class="form-control" placeholder="Ton pseudo" required>
        </div>
        <div class="mb-2">
          <textarea id="content" class="form-control" rows="3" placeholder="Ton message..." required></textarea>
        </div>
        <div class="d-grid">
          <button type="submit" class="btn btn-success">Envoyer</button>
        </div>
      </form>
    </div>
  </div>

<script>
const apiBase = "https://fqw4dpjvh8.execute-api.eu-west-1.amazonaws.com/dev";
let currentChannel = "";
let lastEvaluatedKey = null;
let historyKeys = [];

async function loadMessages(channel_id, startKey = null, isBack = false) {
  if (!channel_id) return;
  currentChannel = channel_id;
  document.getElementById("current_channel").innerText = channel_id;
  const container = document.getElementById("messages");
  const pagination = document.getElementById("pagination");
  container.innerHTML = "<div class='text-center text-secondary'>Chargement...</div>";
  pagination.style.display = "flex";

  try {
    const response = await fetch(`${apiBase}/Getmessages`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ channel_id, last_evaluated_key: startKey })
    });

    const data = await response.json();
    container.innerHTML = "";
    const items = data.items || [];
    lastEvaluatedKey = data.last_evaluated_key || null;

    if (items.length === 0) {
      container.innerHTML = "<div class='text-center text-muted'>Aucun message dans ce channel.</div>";
      document.getElementById("nextBtn").disabled = true;
      return;
    }

    items.forEach(msg => {
      const author = msg.author || msg.username || msg.user_id;
      const content = msg.content;
      const timestamp = msg.timestamp_utc_iso8601
        ? new Date(msg.timestamp_utc_iso8601).toLocaleString("fr-FR", { dateStyle: "short", timeStyle: "short" })
        : "Date inconnue";

      const div = document.createElement("div");
      div.className = "message";
      div.innerHTML = `<strong>${author}</strong> <em class="text-muted">(${timestamp})</em><br>${content}`;
      container.appendChild(div);
    });

    document.getElementById("nextBtn").disabled = !lastEvaluatedKey;
    document.getElementById("prevBtn").disabled = historyKeys.length === 0;
    if (!isBack && startKey) historyKeys.push(startKey);

  } catch (err) {
    container.innerHTML = "<div class='text-danger text-center'>Erreur de chargement des messages.</div>";
    console.error(err);
  }
}

document.getElementById("loadForm").addEventListener("submit", (event) => {
  event.preventDefault();
  const channel_id = document.getElementById("load_channel_id").value.trim();
  if (!channel_id) return alert("Veuillez entrer un channel.");
  historyKeys = [];
  loadMessages(channel_id);
});

document.getElementById("nextBtn").addEventListener("click", () => {
  if (lastEvaluatedKey) loadMessages(currentChannel, lastEvaluatedKey);
});

document.getElementById("prevBtn").addEventListener("click", () => {
  const prevKey = historyKeys.pop();
  loadMessages(currentChannel, prevKey, true);
});

document.getElementById("messageForm").addEventListener("submit", async (event) => {
  event.preventDefault();
  if (!currentChannel) return alert("Veuillez d'abord s√©lectionner un channel.");

  const author = document.getElementById("author").value.trim();
  const content = document.getElementById("content").value.trim();
  if (!author || !content) return alert("Auteur et contenu requis.");

  const message = { author, content, channel_id: currentChannel };
  try {
    const response = await fetch(`${apiBase}/messages`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(message)
    });

    if (response.ok) {
      document.getElementById("content").value = "";
      loadMessages(currentChannel);
    } else {
      alert("Erreur lors de l‚Äôenvoi du message.");
    }
  } catch (err) {
    alert("Impossible d‚Äôenvoyer le message.");
    console.error(err);
  }
});

window.addEventListener("DOMContentLoaded", () => {
  loadMessages("astra");
});
</script>
</body>
</html>
